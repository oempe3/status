<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CSV - Atualização em Lote</title>
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>
  <header>
    <img src="logomarca.png" alt="Logo Pernambuco III">
    <nav>
      <a href="status.html">Status</a> |
      <a href="entrada.html">Atualizar</a> |
      <a href="csv_update.html">CSV Lote</a> |
      <a href="index.html" style="color:#ff6b6b">Sair</a>
    </nav>
  </header>
  <div class="container">
    <h2>Atualização por CSV</h2>
    <input type="file" id="csvFile" accept=".csv"><br>
    <button onclick="enviarCSV()">Enviar CSV</button>
    <button onclick="exportarCSV()">Exportar CSV Atual</button>
    <div class="msg" id="msg"></div>
  </div>
  <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbzHw6qRm9QHOBIZYuyfRpEDVLztVNTl826yf3lJR5rJfP69ZRZL90z4X3GKLZv3ejWW/exec";

    function enviarCSV() {
      const fileInput = document.getElementById('csvFile');
      const msg = document.getElementById('msg');
      msg.textContent = '';

      if (!fileInput.files.length) {
        msg.textContent = 'Selecione um arquivo CSV.';
        msg.className = "msg erro";
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const text = e.target.result;
        const rows = text.split('\n').map(r => r.split(','));
        const headers = rows[0];
        const data = rows.slice(1).map(row => {
          let obj = {};
          headers.forEach((h, i) => obj[h.trim()] = row[i]?.trim());
          obj['DATA'] = new Date().toISOString();
          return obj;
        });

        fetch(endpoint, {
          method: 'POST',
          body: JSON.stringify(data),
          headers: {'Content-Type': 'application/json'}
        }).then(res => res.json())
          .then(r => {
            msg.textContent = 'Dados enviados com sucesso!';
            msg.className = "msg sucesso";
          }).catch(err => {
            msg.textContent = 'Erro ao enviar os dados.';
            msg.className = "msg erro";
          });
      };
      reader.readAsText(fileInput.files[0]);
    }

    function exportarCSV() {
      fetch(endpoint)
        .then(res => res.json())
        .then(data => {
          const header = Object.keys(data[0]).join(',');
          const rows = data.map(obj => Object.values(obj).map(v => `"${(v || '').toString().replace(/"/g, '""')}"`).join(','));
          const csvContent = [header, ...rows].join('\n');
          const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'dados_exportados.csv';
          a.click();
        });
    }
  </script>
</body>
</html>
